<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../things-i18n-msg/things-i18n-msg.html">
<link rel="import" href="../things-ws/things-ws-subscriber.html">

<link rel="import" href="../things-scene-chartjs/things-scene-chartjs.html">
<link rel="import" href="../things-scene-controlchart/things-scene-controlchart.html">
<link rel="import" href="../things-scene-three-container/things-scene-three-container.html">
<link rel="import" href="../things-scene-viewer/things-scene-viewer.html">

<link rel="import" href="./things-menu-content-behavior.html">

<!--
  Things-point와 연동하여 Scene Content를 화면에 표시. 
  Scene 모니터링 (subscribe) 기능 포함 
  메뉴 정보에 Scene 정보를 가져올 수 있도록 resource_url 필드가 설정되어야  함.
-->

<dom-module id="things-scene-content">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      things-scene-viewer {
        @apply(--layout-flex)
      }
    </style>

    <things-ws-subscriber id="subscriber"
                          !auto
                          url-key="wsUrl" 
                          subject="[[publishSubject]]">
    </things-ws-subscriber>

    <things-search-form  id="search-form"
                         title="[[menuInfo.title]]"
                         form-fields="[[searchFormFieldsInfo]]"
                         action-url="[[viewerUrl]]" 
                         last-response="{{response}}">
    </things-search-form>

    <things-ajax  auto
                  id="get-menu-params"
                  resource-url="menus/:id/menu_params"
                  resource-id="[[menuInfo.id]]"
                  last-response="{{menuParams}}">
    </things-ajax>

    <things-ajax  auto
                  id="get-scene"
                  resource-url="[[menuInfo.resource_url]]"
                  last-response="[[response]]">
    </things-ajax>

    <things-ajax  id="polling-ajax"
                  resource-url="[[pollingUrl]]"
                  last-response="{{pollingResponse}}">
    </things-ajax>

    <things-scene-viewer model="[[model]]"
                         values="[[monitoringData]]"
                         mode="1"
                         fit="both"
                         base-url="[[globals.baseUrl]]">
    </things-scene-viewer>
  </template>

  <script>
    Polymer({
      is: 'things-scene-content',

      behaviors: [
        Things.MenuContentBehavior
      ],

      properties: {

        /**
         * Viewer 조회 URL
         */
        viewerUrl: {
          type: String,
          observer: 'viewerUrlChanged'
        },

        /**
         * menu id를 이용하여 menu param을 조회한 결과
         */
        menuParams: {
          type: Array,
          observer: 'menuParamsChanged'
        },

        /**
         * 검색 폼 내용 
         */
        searchFormFieldsInfo: {
          type: Array,
          value: function() {
            return [ {
              label: Things.DataGlobal.t('label.start'),
              name: 'start',
              op: 'eq',
              searchForm: true,
              type: 'tristate-radio'
            } ];
          }
        },

        /**
         * Scene Model
         */
        model: {
          type: Object
        },

        /**
         * Scene 정보 조회 후 ...
         */
        response: {
          type: Object,
          observer: 'responseChanged'
        },

        /**
         * polling interval (second)
         */
        pollingInterval: {
          type: String,
          value: 10
        },

        /**
         * polling target url
         */
        pollingUrl: {
          type: String
        },

        /**
         * polling에 의한 response
         */
        pollingResponse: {
          type: Array,
          observer: 'pollingResponseChanged'
        },

        /**
         * async Polling
         */
        _asyncPolling: {
          type: Object
        },

        /**
         * publish subject
         */
        publishSubject: {
          type: String
        },

        /**
         * 모니터링 데이터 
         */
        monitoringData: {
          type: Object
        }
      },

      observers: [
        'viewerMenuInfoChanged(menuInfo)'
      ],

      listeners: {
        'search-form.things-search-form-configured' : 'searchFormConfigured'
      },

      ready: function() {
        document.addEventListener('things-toggle-play-pages', function(event) {
          var power = event.detail;
          this.playPagesToggled(power);
        }.bind(this));
      },

      /**
       * 메뉴 정보 변경시 
       */
      viewerMenuInfoChanged: function(menuInfo) {
        this.viewerUrl = menuInfo.resource_url;
      },

      /**
       * fullscreen 변경시 event listener
       */
      playPagesToggled: function(power) {
        if(power == 'on' && this.publishSubject) {
          this.startSubscribe();
        } 

        if (power == 'on' && this.pollingUrl) {
          this.startPolling();
        }

        if (power == 'off') {
          this.stopSubscribe();
          this.stopPolling();
        }
      },

      /**
       * Viewer URL 변경시  
       */
      viewerUrlChanged: function(viewerUrl) {
        this.$['search-form'].submitMyForm();
      },

      /**
       * 검색 폼 구성 후 
       */
      searchFormConfigured: function(e) {
        this.$['search-form'].submitMyForm();
      },

      /**
       * Scene 정보 조회 후 모델 설정 
       */
      responseChanged: function(data) {
        if(data) {
          this.model = JSON.parse(data.model);
          this.publishSubject = '/elidom/stomp/topic/hatiolab-hq/smart/' + data.name;
        }
      },

      /**
       * menuParam이 변화하면
       * pollingInterval, pollingUrl, publishSubject를 초기화
       */
      menuParamsChanged: function(menuParams) {
        var me = this;

        menuParams.forEach(function(item) {
          if(item.name == 'polling_interval') {
            me.pollingInterval = item.value;
          } else if (item.name == 'polling_url') {
            me.pollingUrl = item.value;
          } else if (item.name == 'publish_subject') {
            me.publishSubject = item.value;
          }
        });
      },

      /**
       * Start monitoring
       */
      startSubscribe: function() {
        var connected = this.$.subscriber.status();
        if(!connected) {
          this.$.subscriber.callback = this.messageReceived.bind(this);
          this.$.subscriber.start();
        }
      },

      /**
       * Stop monitoring
       */
      stopSubscribe: function() {
        var connected = this.$.subscriber.status();
        if(connected) {
          this.$.subscriber.stop();
        }
      },

      /**
       * polling async start
       */
      startPolling: function() {
        this._asyncPolling = this.async(this.startPolling, this.pollingInterval);
        this.$['polling-ajax'].generateRequest();
      },

      /**
       * polling async clear and stop
       */
      stopPolling: function() {
        if(!this._asyncPolling) return;
        this.cancelAsync(this._asyncPolling);
        this._asyncPolling = null;
      },

      /**
       * polling data responsed
       */
      pollingResponseChanged: function(data) {
        this.messageReceived(data);
      },

      /**
       * 모니터링 데이터를 받음 ...
       */
      messageReceived: function(message) {
        this.monitoringData = message;
      }
    });
  </script>
</dom-module>