<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../things-detail/things-menu-detail-opener.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">
<link rel="import" href="../things-meta/things-menu-meta-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-view-open-behavior/things-view-open-behavior.html">

<link rel="import" href="../iron-signals/iron-signals.html">

<script>

window.Things = window.Things || {};

/**
 * 팝업 디테일 Behavior
 *
 * @polymerBehavior Things.DetailPopupBehavior
 */
Things.DetailPopupBehaviorImpl = {

	/**
	 * Life Cycle - Ready
	 */
	ready: function() {
		var grid = this.$['grid'];
		if(grid) {
			this.listen(grid, 'things-grid-detail-tap', 'showDetailView');
		}
	},

	/**
	 * 디테일 뷰를 표시한다.
	 *
	 * @param {Event} event 그리드에서 선택된 event
	 */
	showDetailView: function(event) {
		if(!event.detail.id) return;

		if(!this.menuInfo.detail_form_id || this.menuInfo.detail_form_id == 'things-resource-form') {
			this.showResourceForm(event.detail, this.refreshGridData.bind(this));

		} else if(this.menuInfo.detail_form_id && this.menuInfo.detail_form_id == 'things-resource-detail') {
			if(this.menuInfo.detail_layout) {
				var detail = { detail: { menuInfo: this.menuInfo, resource: event.detail, resourceFormFields: this.resourceFormFields, closeCallback: this.refreshGridData.bind(this)}};
				var customEvent = new CustomEvent('things-open-menu-detail-view', detail);
				document.dispatchEvent(customEvent);
			}

		} else if(this.menuInfo.detail_form_id != 'custom') {
			this.showCustomView(this.menuInfo.detail_form_id, event.detail, this.refreshGridData.bind(this));
		}
	},
	
	/**
	 * 표준화된 리소스 디테일 폼을 표시한다.
	 *
	 * @param {Object} selectedRecord 그리드에서 선택된 Row Data
	 * @param {Function} saveCallback 저장 후 콜백 함수 
	 */
	showResourceForm: function(selectedRecord, saveCallback) {
		var viewElement = document.createElement('things-resource-form');
		this._setViewConfig('detail-view', viewElement, selectedRecord, saveCallback);
		var eventDetail = { view: viewElement, modal: true, closeCallback: saveCallback };
		var event = new CustomEvent('things-open-popup-view', { 'detail': eventDetail });
		document.dispatchEvent(event);
	},

	/**
	 * 프레임 웍에서 기본으로 제공하지 않는 리소스 디테일 폼을 표시한다.
	 *
	 * @param {String} detailViewId 상세 뷰 아이디 
	 * @param {Object} selectedRecord 그리드에서 선택된 Row Data
	 * @param {Function} saveCallback 저장 후 콜백 함수 
	 */
	showCustomView: function(detailViewId, selectedRecord, saveCallback) {
		var viewElement = document.createElement(detailViewId);
		viewElement.attachable = true;
		viewElement.propExtensible = true;
		viewElement.saveCallback = saveCallback;
		this._setViewConfig('detail-view', viewElement, selectedRecord, saveCallback);
		viewElement.showDetailView(selectedRecord.id, selectedRecord, null, saveCallback);
	},

	/**
	 * 선택된 레코드로 상세 뷰 Properties를 설정한다.
	 *
	 * @param {String} elementId
	 * @param {Object} viewElement
	 * @param {Object} selectedRecord
	 * @param {Function} saveCallback 저장 후 콜백 함수 
	 */
	_setViewConfig: function(elementId, viewElement, selectedRecord, saveCallback) {
		viewElement.id = elementId;
		viewElement.title = this.menuInfo.title + (selectedRecord && selectedRecord.name ? ' (' + selectedRecord.name + ')' : '');
		viewElement.formFields = this.resourceFormFields;
		viewElement.removeFieldsOnSave = this.ignoreFieldsOnSave;
		viewElement.resourceType = this.menuInfo.resource_name;
		viewElement.resourceId = selectedRecord ? selectedRecord.id : null;
		var eventName = 'things-resource-form-saved';

		if(selectedRecord && selectedRecord.id) {
			viewElement.resourceUrl = this.menuInfo.resource_url + '/:id';
		} else {
			eventName = 'things-resource-form-created';
			selectedRecord ? viewElement.resource = selectedRecord : '';
			viewElement.resourceUrl = this.menuInfo.resource_url;
		}
		
		viewElement.addEventListener(eventName, function(e) {
			viewElement.closePopupView();
			saveCallback.apply(this);
		}.bind(this));
	}

};

Things.DetailPopupBehavior = [
	Things.DetailPopupBehaviorImpl,
	Things.ViewOpenBehavior
];

</script>